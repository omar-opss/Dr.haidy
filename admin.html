<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDvdYelGHJPA49QsZ9wCaAyy9tT-eP3nrw",
    authDomain: "clinic-booking-eeaee.firebaseapp.com",
    databaseURL: "https://clinic-booking-eeaee-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "clinic-booking-eeaee",
    storageBucket: "clinic-booking-eeaee.appspot.com",
    messagingSenderId: "21071960927",
    appId: "1:21071960927:web:d46bea119060b4f046b4ea"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const tableBody = document.getElementById("tableBody");

  function fetchBookings() {
    const bookingsRef = ref(database, 'bookings/');
    onValue(bookingsRef, (snapshot) => {
      tableBody.innerHTML = "";

      let total = 0;
      let allTimes = [];
      let allDays = new Set();

      snapshot.forEach(dateSnap => {
        const dateKey = dateSnap.key;
        allDays.add(dateKey);
        const timesSnap = dateSnap.val();

        for (let timeKey in timesSnap) {
          const timeGroup = timesSnap[timeKey];

          for (let bookingId in timeGroup) {
            const data = timeGroup[bookingId];
            const name = data.name || "‚Äî";
            const phone = data.phone || "‚Äî";
            const date = data.date || dateKey;
            const time = data.time || timeKey;
            const attended = data.attended ? "‚úîÔ∏è" : "‚ùå";

            total++;
            allTimes.push(time);

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${name}</td>
              <td>${phone}</td>
              <td><button onclick="sendWhatsapp('${phone}', '${name}', '${date}', '${time}')">üì§</button></td>
              <td>${date}</td>
              <td>${time}</td>
              <td><button onclick="toggleAttended('${dateKey}', '${timeKey}', '${bookingId}', ${data.attended ? 'false' : 'true'})">${attended}</button></td>
              <td><button onclick="deleteBooking('${dateKey}', '${timeKey}', '${bookingId}')">üóë</button></td>
            `;
            tableBody.appendChild(tr);
          }
        }
      });

      document.getElementById("totalBookings").innerText = total;
      document.getElementById("bookingDays").innerText = allDays.size;

      const timeCounts = {};
      allTimes.forEach(t => timeCounts[t] = (timeCounts[t] || 0) + 1);
      const peak = Object.entries(timeCounts).sort((a, b) => b[1] - a[1])[0];
      document.getElementById("peakTime").innerText = peak ? `${peak[0]} (${peak[1]})` : "‚Äî";
    });
  }

  window.sendWhatsapp = function(phone, name, date, time) {
    const internationalPhone = phone.startsWith("0") ? "2" + phone.slice(1) : phone;
    const msg = `ŸÖÿ±ÿ≠ÿ®Ÿãÿß ${name}ÿå ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ¨ÿ≤ŸÉ ÿ®ÿ™ÿßÿ±ŸäÿÆ ${date} ÿßŸÑÿ≥ÿßÿπÿ© ${time} ŸÅŸä ÿπŸäÿßÿØÿ© ÿØŸÉÿ™Ÿàÿ±ÿ© ÿ£ÿ≥ŸÖÿßÿ°.`;
    const url = `https://wa.me/${internationalPhone}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
  };

  window.toggleAttended = function(date, time, id, newState) {
    const bookingRef = ref(database, `bookings/${date}/${time}/${id}`);
    update(bookingRef, { attended: newState });
    fetchBookings();
  };

  window.deleteBooking = function(date, time, id) {
    const bookingRef = ref(database, `bookings/${date}/${time}/${id}`);
    remove(bookingRef).then(() => {
      alert("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ¨ÿ≤");
      fetchBookings();
    });
  };

  function login() {
    const pass = document.getElementById("adminPass").value;
    if (pass === "omar2025") {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";
      fetchBookings();
    } else {
      alert("ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©");
    }
  }

  window.login = login;

  window.exportToExcel = function () {
    const rows = [];
    const headers = ["ÿßŸÑÿßÿ≥ŸÖ", "ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ", "ÿ™ÿßÿ±ŸäÿÆ", "ŸàŸÇÿ™", "ÿßŸÑÿ≠ÿ∂Ÿàÿ±"];
    rows.push(headers);

    document.querySelectorAll("#tableBody tr").forEach(row => {
      const cells = row.querySelectorAll("td");
      if (cells.length >= 5) {
        const rowData = [
          cells[0].innerText,
          cells[1].innerText,
          cells[3].innerText,
          cells[4].innerText,
          cells[5].innerText
        ];
        rows.push(rowData);
      }
    });

    const worksheet = XLSX.utils.aoa_to_sheet(rows);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Bookings");

    XLSX.writeFile(workbook, "ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™.xlsx");
  };
</script>
